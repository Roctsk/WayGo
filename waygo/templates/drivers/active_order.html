{% extends "base.html" %}
{% load static %}

{% block title %}Кабінет водія{% endblock %}

{% block content %}

<div class="container-fluid p-0">
    <div id="map" style="height: 80vh;"></div>

    <div class="p-3 bg-white shadow fixed-bottom">
        <p><b>Звідки:</b> {{ order.pickup_address }}</p>
        <p><b>Куди:</b> {{ order.destination_address }}</p>

        {% if order.status == "accepted" %}
            <a href="{% url 'order_on_the_way' %}" class="btn btn-primary w-100">
                Почати поїздку
            </a>
        {% elif order.status == "on_the_way" %}
            <a href="{% url 'order_arrived' %}" class="btn btn-warning w-100">
                Я прибув
            </a>
        {% elif order.status == "arrived" %}
            <a href="{% url 'order_complete' %}" class="btn btn-success w-100">
                Завершити поїздку
            </a>
        {% endif %}
    </div>
</div>


<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>


<script>
const pickupAddress = "{{ order.pickup_address|escapejs }}";
const destinationAddress = "{{ order.destination_address|escapejs }}";


const map = L.map('map').setView([49.8397, 24.0297], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
}).addTo(map);


async function geocode(address){
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
    const response = await fetch(url);
    const data = await response.json();
    if (data.length === 0){
        alert("Не вдалося знайти адресу" + address)
        return null
    }

    return L.latLng(
        parseFloat(data[0].lat),
        parseFloat(data[0].lon)
    );

}

async function buildRoute(){
    const start = await geocode(pickupAddress)
    const end = await geocode(destinationAddress)

    if (!start || !end ) return;

    L.Routing.control({
        waypoints: [start,end],
        routeWhileDragging: true,
        show: false,
        addWaypoints: false
    }).addTo(map);

    map.fitBounds(L.latLngBounds([start,end]))

}

buildRoute();
</script>

{% endblock %}
