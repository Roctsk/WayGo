{% extends "base.html" %}
{% load static %}

{% block title %}Кабінет кур'єра{% endblock %}

{% block content %}

<div class="container-fluid p-0">
    <div id="map" style="height: 80vh;"></div>

    <div class="p-3 bg-white shadow fixed-bottom">
        <p><b>Звідки:</b> {{ order.pickup_address }}</p>
        <p><b>Куди:</b> {{ order.delivery_address }}</p>

        {% if order.status == "accepted" %}
            <a href="{% url 'courier_order_on_the_way' %}" class="btn btn-primary w-100">
                Почати доставку
            </a>
        {% elif order.status == "on_the_way" %}
            <a href="{% url 'courier_order_arrived' %}" class="btn btn-warning w-100">
                Я прибув
            </a>
        {% elif order.status == "arrived" %}
            <a href="{% url 'courier_order_complete' %}" class="btn btn-success w-100">
                Завершити доставку
            </a>
        {% endif %}
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script type="application/json" id="order-coords">
    {
        "pickup_lat": {{ order.pickup_lat|default:"null" }},
        "pickup_lon": {{ order.pickup_lon|default:"null" }},
        "dest_lat": {{ order.dest_lat|default:"null" }},
        "dest_lon": {{ order.dest_lon|default:"null" }}
    }
</script>

<script>
const coordsEl = document.getElementById("order-coords");
let coords = { pickup_lat: null, pickup_lon: null, dest_lat: null, dest_lon: null };

try {
    coords = JSON.parse(coordsEl.textContent);
} catch (e) {
    console.warn("Немає координат замовлення");
}

const map = L.map('map').setView([49.8397, 24.0297], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
}).addTo(map);

if (coords.pickup_lat && coords.pickup_lon && coords.dest_lat && coords.dest_lon) {
    const start = L.latLng(parseFloat(coords.pickup_lat), parseFloat(coords.pickup_lon));
    const end = L.latLng(parseFloat(coords.dest_lat), parseFloat(coords.dest_lon));

    L.marker(start).addTo(map).bindPopup("Точка A");
    L.marker(end).addTo(map).bindPopup("Точка B");

    L.Routing.control({
        waypoints: [start, end],
        addWaypoints: false,
        routeWhileDragging: false,
        show: false
    }).addTo(map);

    map.fitBounds([start, end]);
}
</script>

{% endblock %}
