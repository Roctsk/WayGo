{% extends "base.html" %}
{% load static %}

{% block title %}Кабінет кур'єра{% endblock %}

{% block content %}

<div class="container-fluid p-0">
    <div id="map" style="height: 80vh;"></div>

    <div class="p-3 bg-white shadow fixed-bottom">
        <p><b>Звідки:</b> {{ order.pickup_address }}</p>
        <p><b>Куди:</b> {{ order.delivery_address }}</p>

        {% if order.status == "accepted" %}
            <a href="{% url 'courier_order_on_the_way' %}" class="btn btn-primary w-100">
                Почати доставку
            </a>
        {% elif order.status == "on_the_way" %}
            <a href="{% url 'courier_order_arrived' %}" class="btn btn-warning w-100">
                Я прибув
            </a>
        {% elif order.status == "arrived" %}
            <a href="{% url 'courier_order_complete' %}" class="btn btn-success w-100">
                Завершити доставку
            </a>
        {% endif %}
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
const orderData = {
    pickupAddress: "{{ order.pickup_address|escapejs }}",
    deliveryAddress: "{{ order.delivery_address|escapejs }}"
};

const map = L.map('map').setView([49.8397, 24.0297], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
}).addTo(map);

async function geocodeAddress(address) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&accept-language=uk&countrycodes=ua&q=${encodeURIComponent(address)}`;
    const response = await fetch(url);
    const results = await response.json();

    if (!results.length) return null;

    return L.latLng(parseFloat(results[0].lat), parseFloat(results[0].lon));
}

async function buildRouteByAddresses() {
    try {
        const [start, end] = await Promise.all([
            geocodeAddress(orderData.pickupAddress),
            geocodeAddress(orderData.deliveryAddress)
        ]);

        if (!start || !end) {
            console.warn("Не вдалося знайти координати однієї з адрес");
            return;
        }

        L.marker(start).addTo(map).bindPopup("Точка A");
        L.marker(end).addTo(map).bindPopup("Точка B");

        L.Routing.control({
            waypoints: [start, end],
            addWaypoints: false,
            routeWhileDragging: false,
            show: false
        }).addTo(map);

        map.fitBounds([start, end], { padding: [30, 30] });
    } catch (error) {
        console.error("Помилка побудови маршруту:", error);
    }
}

buildRouteByAddresses();
</script>

{% endblock %}
